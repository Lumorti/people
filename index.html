 <!DOCTYPE html>
<html>

<style>

	#wrapper {
		position: absolute;
		left: 50%;
		top: 50%;
		width: 100%;
		height: 100%;
		max-width: 700px;
		max-height: 700px;
		-webkit-transform: translate(-50%, -50%);
		transform: translate(-50%, -50%);
	}
	
	#main {
		width: 100%;
		height: 100%;
		border: 5px solid black;
	}

</style>

<script>

	// Objects holding the preloaded SVGs
	var peopleSVG = new Image();
	var objectsSVG = new Image();
	var placesSVG = new Image();

	// SVG sizings
	var placeLoc = [0, 0, 500, 250];
	var objectLoc = [0, 0, 100, 100];
	var peopleLoc = [0, 0, 100, 100];
	var placeWidth = 0;
	var placeHeight = 0;

	// For converting
	var toRad = Math.PI / 180.0;
	var toDeg = 180.0 / Math.PI;

	// Poses 
	// [neck, lArmUpper, lArmLower, rArmUpper, rArmLower, 
    //  lLegUpper, lLegLower, rLegUpper, rLegLower]
	poses = {
		"standing":     [0,  0,   0, 0, 0,   0,   0,   0,   0, 0],
		"holding":      [0,  0, -90, 0, 0,   0,   0,   0,   0, 0],
		"drinking":     [0,-50,-100, 0, 0,   0,   0,   0,   0, 0],
		"walkTran":     [0,  0,   0, 0, 0,   0,   0,   0,   0, 0],
		"walk1":        [0,  0,   0, 0, 0, -30,  40,  10,   5, 0],
		"walk2":        [0,  0,   0, 0, 0, -20,  10,  20,  10, 0],
		"walk3":        [0,  0,   0, 0, 0,  10,  10, -35,  35, 0],
		"walk4":        [0,  0,   0, 0, 0,  10,  10, -20,  10, 0],
		"walkHoldTran": [0,  0, -90, 0, 0, -30,  30,   0,   0, 0],
		"walkHold1":    [0,  0,   0, 0, 0, -30,  40,  10,   5, 0],
		"walkHold2":    [0,  0,   0, 0, 0, -20,  10,  20,  10, 0],
		"walkHold3":    [0,  0,   0, 0, 0,  10,  10, -35,  35, 0],
		"walkHold4":    [0,  0,   0, 0, 0,  10,  10, -20,  10, 0],
		"sat":          [0,  0, -20, 0, 0, -60,  30, -60,  30, 0],
		"satHold":      [0,  0, -90, 0, 0, -60,  30, -60,  30, 0],
		"satDrinking":  [0,-20, -90, 0, 0, -60,  30, -60,  30, 0],
	};

	// Timings
	var lastRender = 0;

	// DOM objects
	var canvasObj;
	var ctx;

	// Keep track of all the people
	var people = [];

	// Possible conversation locations
	var conversations = [
		{"people": [], "locs": [300, 350, 400]}, // Sofa and chairs
	];

	// For DEBUGging
	var debugText = "";

	// Called when the page loads
	function init() {

		// Preload the SVGs
		peopleSVG.onload = function() {};
		peopleSVG.src = "people.svg";
		objectsSVG.onload = function() {};
		objectsSVG.src = "objects.svg";
		placesSVG.onload = function() {};
		placesSVG.src = "places.svg";

		// Get the canvas
		canvas = document.getElementById("main");
		canvas.width = canvas.offsetWidth;
		canvas.height = canvas.offsetHeight;
		ctx = canvas.getContext("2d");
		ctx.scale(1.5, 1.5);

		// Start the loop
		window.requestAnimationFrame(loop);

		// The template to copy for each person
		var personTemplate = {"sprite": 0, 
							  "loc": 100, 
							  "x": 100, 
							  "y": 133, 
							  "angles": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
							  "angleDeltas": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
							  "pose": "standing", 
							  "destinationLoc": 100, 
							  "boredom": 0, 
							  "drinkLeft": 0, 
							  "fixedPose": false, 
							  "fixedLoc": false, 
							  "facingRight": true, 
							  "bladder": 0, 
							  "drinkTimer": 0, 
							  "conversationInd": -1, 
							  "holding": -1, 
							  "action": "standing"};

		// Add a test person
		people.push(JSON.parse(JSON.stringify(personTemplate)));

		// Walk cycle testing TODO
		/*people.push(JSON.parse(JSON.stringify(personTemplate)));*/
		/*people[people.length-1].fixedPose = true;*/
		/*people[people.length-1].fixedLoc = true;*/
		/*people[people.length-1].x = 50;*/
		/*people[people.length-1].loc = people[people.length-1].x;*/
		/*people.push(JSON.parse(JSON.stringify(personTemplate)));*/
		/*people[people.length-1].fixedPose = true;*/
		/*people[people.length-1].fixedLoc = true;*/
		/*people[people.length-1].x = 100;*/
		/*people[people.length-1].loc = people[people.length-1].x;*/
		/*for (var j=0; j<10; j++) {*/
			/*people[people.length-1].angles[j] = poses["walkTran"][j];*/
		/*}*/
		/*people.push(JSON.parse(JSON.stringify(personTemplate)));*/
		/*people[people.length-1].fixedPose = true;*/
		/*people[people.length-1].fixedLoc = true;*/
		/*people[people.length-1].x = 150;*/
		/*people[people.length-1].loc = people[people.length-1].x;*/
		/*for (var j=0; j<10; j++) {*/
			/*people[people.length-1].angles[j] = poses["walk1"][j];*/
		/*}*/
		/*people.push(JSON.parse(JSON.stringify(personTemplate)));*/
		/*people[people.length-1].fixedPose = true;*/
		/*people[people.length-1].fixedLoc = true;*/
		/*people[people.length-1].x = 200;*/
		/*people[people.length-1].loc = people[people.length-1].x;*/
		/*for (var j=0; j<10; j++) {*/
			/*people[people.length-1].angles[j] = poses["walk2"][j];*/
		/*}*/
		/*people.push(JSON.parse(JSON.stringify(personTemplate)));*/
		/*people[people.length-1].fixedPose = true;*/
		/*people[people.length-1].fixedLoc = true;*/
		/*people[people.length-1].x = 250;*/
		/*people[people.length-1].loc = people[people.length-1].x;*/
		/*for (var j=0; j<10; j++) {*/
			/*people[people.length-1].angles[j] = poses["walk3"][j];*/
		/*}*/
		/*people.push(JSON.parse(JSON.stringify(personTemplate)));*/
		/*people[people.length-1].fixedPose = true;*/
		/*people[people.length-1].fixedLoc = true;*/
		/*people[people.length-1].x = 300;*/
		/*people[people.length-1].loc = people[people.length-1].x;*/
		/*for (var j=0; j<10; j++) {*/
			/*people[people.length-1].angles[j] = poses["walk4"][j];*/
		/*}*/
		/*people.push(JSON.parse(JSON.stringify(personTemplate)));*/
		/*people[people.length-1].fixedLoc = true;*/
		/*people[people.length-1].x = 400;*/
		/*people[people.length-1].loc = people[people.length-1].x;*/
		/*people[people.length-1].destinationLoc = people[people.length-1].loc;*/

	}

	// Update the various people
	function update(progress) {

		// Check if people are ready for new actions
		for (var i=0; i<people.length; i++) {

			// If the person is bored of their current action
			if (people[i].boredom >= 100) {

				// Clear current conversation
				if (people[i].conversationInd >= 0) {
					conversations[people[i].conversationInd].people.splice(conversations.indexOf(i), 1);
					people[i].conversationInd = -1;
				}

				// If drink is empty
				if (people[i].holding != -1 && people[i].drinkLeft <= 0) {
					people[i].destinationLoc = 530;
					people[i].action = "goingToBin";
					people[i].boredom = 0;

				// If need to pee
				} else if (people[i].bladder >= 100) {
					people[i].destinationLoc = 100;
					people[i].action = "goingToBathroom";
					people[i].boredom = 0;

				// If don't have a drink
				} else if (people[i].holding == -1) {
					people[i].destinationLoc = 460;
					people[i].action = "goingToFridge";
					people[i].boredom = 0;

				// Choose a conversation to join
				} else {

					// For each possible conversation
					for (var j=0; j<conversations.length; j++){
						
						// If there is space free, join
						if (conversations[j].people.length < conversations[j].locs.length) {
							people[i].conversationInd = j;
							people[i].destinationLoc = conversations[j].locs[conversations[j].people.length];
							people[i].action = "goingToTalk";
							conversations[j].people.push(i);
							people[i].boredom = 0;
							break;
						}

					}

				}

			// Otherwise they get a bit more bored if not walking
			} else if (people[i].action.indexOf("going") < 0 ) {

				// If they're stood alone
				if (people[i].conversationInd == -1) {
					people[i].boredom += 1;

				// If they're in a conversation
	 			} else {
					people[i].boredom += 0.2;

				}

			}

			// DEBUG
			if (!people[i].fixedLoc){

				// Move their X
				if (people[i].loc > people[i].destinationLoc) {
					people[i].loc -= 1.2;
					people[i].facingRight = false;
				} else if (people[i].loc < people[i].destinationLoc) {
					people[i].loc += 1.2;
					people[i].facingRight = true;
				}

				// Update Y based on X
				if (people[i].loc > 440) {
					people[i].x = people[i].loc-240;
					people[i].y = 340;
				} else {
					people[i].x = people[i].loc;
					people[i].y = 133;
				}

			}

			if (!people[i].fixedPose){

				// Move towards their pose
				var maxDelta = -1000;
				for (var j=0; j<10; j++) {
					var delta = poses[people[i].pose][j] - people[i].angles[j];
					maxDelta = Math.max(Math.abs(delta), maxDelta);
					if (Math.abs(delta) > 1){
						people[i].angles[j] += people[i].angleDeltas[j];
					}
				}

				// See if the pose needs changing
				if (Math.abs(maxDelta) < 2){

					// Save the old pose
					var oldPose = people[i].pose;

					// Stopping walking
					if      (people[i].action == "standing" && people[i].pose != "standing") {people[i].pose = "standing";}
					else if (people[i].action == "holding" && people[i].pose.indexOf("walk") >= 0) {people[i].pose = "holding";}
					
					// Walk cycle
					else if (people[i].pose == "walk1") {people[i].pose = "walk2";}
					else if (people[i].pose == "walk2") {people[i].pose = "walk3";}
					else if (people[i].pose == "walk3") {people[i].pose = "walk4";}
					else if (people[i].pose == "walk4") {people[i].pose = "walk1";}

					// Walk cycle whilst holding something
					else if (people[i].pose == "walkHold1") {people[i].pose = "walkHold2";}
					else if (people[i].pose == "walkHold2") {people[i].pose = "walkHold3";}
					else if (people[i].pose == "walkHold3") {people[i].pose = "walkHold4";}
					else if (people[i].pose == "walkHold4") {people[i].pose = "walkHold1";}

					// Starting to walk
					else if ((people[i].pose == "standing" || people.pos == "holding") && people[i].action.indexOf("going") >= 0) {people[i].pose = "walk1";}
					else if (people[i].pose == "walkTran") {people[i].pose = "walk1";}
					else if (people[i].pose == "walkHoldTran") {people[i].pose = "walkHold1";}

					// Drink cycle
					else if (people[i].drinkTimer >= 100 && people[i].action == "holding" && people[i].pose == "holding") {people[i].pose = "drinking";}
					else if (people[i].drinkTimer <= 0 && people[i].action == "holding" && people[i].pose == "drinking") {people[i].pose = "holding";}

					// Calculate the delta needed each frame between these poses
					for (var j=0; j<10; j++) {
						people[i].angleDeltas[j] = (poses[people[i].pose][j] - poses[oldPose][j]) / 20.0;
					}

				}

				// Idle people should drink sometimes
				if (people[i].pose == "drinking" && people[i].drinkLeft >= 0 && people[i].drinkTimer >= 0) {
					people[i].drinkTimer -= 2.0;
					people[i].bladder += 0.2;
					people[i].drinkLeft -= 0.5;
				} else if (people[i].drinkTimer <= 100) {
					people[i].drinkTimer += 0.5;
				}

				// People in the bathroom
				if (people[i].inBathroom) {
					people[i].bladder -= 0.2;
					if (people[i].bladder <= 0) {
						people[i].inBathroom = false;
						people[i].boredom = 100;
					}
				}

				// If reached the destination
				if (Math.abs(people[i].loc - people[i].destinationLoc) < 2) {

					// Stop them wobbling
					people[i].destinationLoc = people[i].loc;

					// If getting a drink
					if (people[i].action == "goingToFridge") {
						people[i].holding = 0;
						people[i].drinkLeft = 100;
						people[i].action = "holding";
						people[i].boredom = 80;

					// If binning something
					} else if (people[i].action == "goingToBin") {
						people[i].holding = -1;
						people[i].action = "standing";
						people[i].boredom = 80;

					// If going to bathroom
					} else if (people[i].action == "goingToBathroom") {
						people[i].inBathroom = true;

					// If going to sit
					} else if (people[i].action == "goingToTalk") {
						if (people[i].holding == -1) {
							people[i].action = "standing";
						} else {
							people[i].action = "holding";
						}

					}

				}

				// TODO
				debugText = "action " + people[i].action + " thirst " + people[i].drinkTimer.toFixed(1) + " bladder " + people[i].bladder.toFixed(1) + " left " + people[i].drinkLeft.toFixed(1) + " boredom " + people[i].boredom.toFixed(1);

			}

		}

	}

	// Called every frame, handles all the canvas operations
	function draw() {

		// Clear the canvas
		ctx.clearRect(0, 0, canvas.width, canvas.height);

		// Draw the background
		ctx.drawImage(placesSVG, 0, 0, placesSVG.width, placesSVG.height, 0, 0, placesSVG.width, placesSVG.height);

		// Draw the people
		for (var i=0; i<people.length; i++) {

			// If they're hidden, skip the draw
			if (people[i].inBathroom) {
				continue;
			}

			// Draw flipped if needed
			if (!people[i].facingRight){
				ctx.save();
				ctx.translate(people[i].x, people[i].y);
				ctx.scale(-1, 1);
			} else {
				ctx.translate(people[i].x, people[i].y);
			}

			// Overall/torso rotation
			ctx.rotate(people[i].angles[9]*toRad);

			// Right arm
			ctx.translate(9, -30);
			ctx.rotate(people[i].angles[3]*toRad);
			ctx.drawImage(peopleSVG, 2*peopleLoc[2], people[i].sprite*peopleLoc[3], peopleLoc[2], peopleLoc[3], -peopleLoc[2]/2, -peopleLoc[3]/2, peopleLoc[2], peopleLoc[3]);
			ctx.translate(2, 20);
			ctx.rotate(people[i].angles[4]*toRad);
			ctx.drawImage(peopleSVG, 3*peopleLoc[2], people[i].sprite*peopleLoc[3], peopleLoc[2], peopleLoc[3], -peopleLoc[2]/2, -peopleLoc[3]/2, peopleLoc[2], peopleLoc[3]);
			ctx.rotate(-people[i].angles[4]*toRad);
			ctx.translate(-2, -20);
			ctx.rotate(-people[i].angles[3]*toRad);
			ctx.translate(-9, 30);
			
			// Right leg
			ctx.translate(6, 3);
			ctx.rotate(people[i].angles[7]*toRad);
			ctx.drawImage(peopleSVG, 4*peopleLoc[2], people[i].sprite*peopleLoc[3], peopleLoc[2], peopleLoc[3], -peopleLoc[2]/2, -peopleLoc[3]/2, peopleLoc[2], peopleLoc[3]);
			ctx.translate(1, 25);
			ctx.rotate(people[i].angles[8]*toRad);
			ctx.drawImage(peopleSVG, 5*peopleLoc[2], people[i].sprite*peopleLoc[3], peopleLoc[2], peopleLoc[3], -peopleLoc[2]/2, -peopleLoc[3]/2, peopleLoc[2], peopleLoc[3]);
			ctx.rotate(-people[i].angles[8]*toRad);
			ctx.translate(-1, -25);
			ctx.rotate(-people[i].angles[7]*toRad);
			ctx.translate(-6, -3);

			// Torso
			ctx.drawImage(peopleSVG, peopleLoc[2],   people[i].sprite*peopleLoc[3], peopleLoc[2], peopleLoc[3], -peopleLoc[2]/2, -peopleLoc[3]/2, peopleLoc[2], peopleLoc[3]);

			// Head
			ctx.translate(0, -40);
			ctx.rotate(people[i].angles[0]*toRad);
			ctx.drawImage(peopleSVG, 0,              people[i].sprite*peopleLoc[3], peopleLoc[2], peopleLoc[3], -peopleLoc[2]/2, -peopleLoc[3]/2, peopleLoc[2], peopleLoc[3]);
			ctx.rotate(-people[i].angles[0]*toRad);
			ctx.translate(0, 40);

			// Left leg
			ctx.translate(-6, 3);
			ctx.rotate(people[i].angles[5]*toRad);
			ctx.drawImage(peopleSVG, 4*peopleLoc[2], people[i].sprite*peopleLoc[3], peopleLoc[2], peopleLoc[3], -peopleLoc[2]/2, -peopleLoc[3]/2, peopleLoc[2], peopleLoc[3]);
			ctx.translate(1, 25);
			ctx.rotate(people[i].angles[6]*toRad);
			ctx.drawImage(peopleSVG, 5*peopleLoc[2], people[i].sprite*peopleLoc[3], peopleLoc[2], peopleLoc[3], -peopleLoc[2]/2, -peopleLoc[3]/2, peopleLoc[2], peopleLoc[3]);
			ctx.rotate(-people[i].angles[6]*toRad);
			ctx.translate(-1, -25);
			ctx.rotate(-people[i].angles[5]*toRad);
			ctx.translate(6, -3);

			// Left arm
			ctx.translate(-11, -30);
			ctx.rotate(people[i].angles[1]*toRad);
			ctx.drawImage(peopleSVG, 2*peopleLoc[2], people[i].sprite*peopleLoc[3], peopleLoc[2], peopleLoc[3], -peopleLoc[2]/2, -peopleLoc[3]/2, peopleLoc[2], peopleLoc[3]);
			ctx.translate(1, 20);
			ctx.rotate(people[i].angles[2]*toRad);
			if (people[i].holding >= 0) {
				ctx.translate(0, 22);
				ctx.drawImage(objectsSVG, 0, people[i].holding*objectLoc[3], objectLoc[2], objectLoc[3], -objectLoc[2]/2, -objectLoc[3]/2, objectLoc[2], objectLoc[3]);
				ctx.translate(0, -22);
			}
			ctx.drawImage(peopleSVG, 3*peopleLoc[2], people[i].sprite*peopleLoc[3], peopleLoc[2], peopleLoc[3], -peopleLoc[2]/2, -peopleLoc[3]/2, peopleLoc[2], peopleLoc[3]);
			ctx.rotate(-people[i].angles[2]*toRad);
			ctx.translate(-1, -20);
			ctx.rotate(-people[i].angles[1]*toRad);
			ctx.translate(11, 30);

			// Undo torso rotation
			ctx.rotate(-people[i].angles[9]*toRad);
			ctx.translate(-people[i].x, -people[i].y);

			// Flip back if needed
			if (!people[i].facingRight){
				ctx.restore();
			}

		}

		// Write the DEBUG text
		ctx.font = "14px Arial";
		ctx.fillText(debugText, 10, 450);
	}

	// Function calling itself to endlessly loop
	function loop(timestamp) {

		// How much time has passed
		var progress = timestamp - lastRender;

		// Update everything
		update(progress);

		// Re-render everything
		draw();

		// Call the loop again when possible
		lastRender = timestamp;
		window.requestAnimationFrame(loop);

	}

</script>

<body onload="init();">
	<div id="wrapper">
		<canvas id="main"/>
	</div>
</body>

</html> 
