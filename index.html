 <!DOCTYPE html>
<html>

<style>

	#wrapper {
		position: absolute;
		left: 50%;
		top: 50%;
		width: 100%;
		height: 100%;
		max-width: 700px;
		max-height: 700px;
		-webkit-transform: translate(-50%, -50%);
		transform: translate(-50%, -50%);
	}
	
	#main {
		width: 100%;
		height: 100%;
		border: 5px solid black;
	}

</style>

<script>

	// Objects holding the preloaded SVGs
	var peopleSVG = new Image();
	var objectsSVG = new Image();
	var placesSVG = new Image();

	// SVG sizings
	var placeLoc = [0, 0, 500, 250];
	var objectLoc = [0, 0, 100, 100];
	var peopleLoc = [0, 0, 100, 100];
	var placeWidth = 0;
	var placeHeight = 0;

	// For converting
	var toRad = Math.PI / 180.0;
	var toDeg = 180.0 / Math.PI;

	// Poses 
	// [neck, lArmUpper, lArmLower, rArmUpper, rArmLower, 
    //  lLegUpper, lLegLower, rLegUpper, rLegLower]
	poses = {
		"standing":     [0,  0,   0, 0, 0,   0,   0,   0,   0, 0],
		"holding":      [0,  0, -90, 0, 0,   0,   0,   0,   0, 0],
		"drinking":     [0,-20, -90, 0, 0,   0,   0,   0,   0, 0],
		"walkTran":     [0,  0,   0, 0, 0,   0,   0,   0,   0, 0],
		"walk1":        [0,  0,   0, 0, 0, -30,  40,  10,   5, 0],
		"walk2":        [0,  0,   0, 0, 0, -20,  10,  20,  10, 0],
		"walk3":        [0,  0,   0, 0, 0,  10,  10, -35,  35, 0],
		"walk4":        [0,  0,   0, 0, 0,  10,  10, -20,  10, 0],
		"walkHoldTran": [0,  0, -90, 0, 0, -30,  30,   0,   0, 0],
		"walkHold1":    [0,  0, -90, 0, 0, -45,  30,  10,  10, 0],
		"walkHold2":    [0,  0, -90, 0, 0, -30,   5,  30,  20, 0],
		"walkHold3":    [0,  0, -90, 0, 0,  10,   5, -30,  30, 0],
		"walkHold4":    [0,  0, -90, 0, 0,  10,  30, -10,  10, 0],
		"sat":          [0,  0, -20, 0, 0, -60,  30, -60,  30, 0],
		"satHold":      [0,  0, -90, 0, 0, -60,  30, -60,  30, 0],
		"satDrinking":  [0,-20, -90, 0, 0, -60,  30, -60,  30, 0],
	};

	// Timings
	var lastRender = 0;

	// DOM objects
	var canvasObj;
	var ctx;

	// Keep track of all the people
	var people = [];

	// For DEBUGging
	var debugText = "";

	// Called when the page loads
	function init() {

		// Preload the SVGs
		peopleSVG.onload = function() {};
		peopleSVG.src = "people.svg";
		objectsSVG.onload = function() {};
		objectsSVG.src = "objects.svg";
		placesSVG.onload = function() {};
		placesSVG.src = "places.svg";

		// Get the canvas
		canvas = document.getElementById("main");
		canvas.width = canvas.offsetWidth;
		canvas.height = canvas.offsetHeight;
		ctx = canvas.getContext("2d");
		ctx.scale(1.5, 1.5);

		// Start the loop
		window.requestAnimationFrame(loop);

		// The template to copy for each person
		var personTemplate = {"sprite": 0, 
							  "loc": 100, 
							  "x": 100, 
							  "y": 133, 
							  "angles": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
							  "angleDeltas": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 
							  "pose": "standing", 
							  "destinationLoc": 100, 
							  "boredom": 0, 
							  "drinkLeft": 0, 
							  "fixedPose": false, 
							  "fixedLoc": false, 
							  "bladder": 0, 
							  "conversationID": -1, 
							  "holding": -1, 
							  "action": "standing"};

		// Add a test person
		/*people.push(JSON.parse(JSON.stringify(personTemplate)));*/

		// Walk cycle testing TODO
		people.push(JSON.parse(JSON.stringify(personTemplate)));
		people[people.length-1].fixedPose = true;
		people[people.length-1].fixedLoc = true;
		people[people.length-1].x = 50;
		people[people.length-1].loc = people[people.length-1].x;
		people.push(JSON.parse(JSON.stringify(personTemplate)));
		people[people.length-1].fixedPose = true;
		people[people.length-1].fixedLoc = true;
		people[people.length-1].x = 100;
		people[people.length-1].loc = people[people.length-1].x;
		for (var j=0; j<10; j++) {
			people[people.length-1].angles[j] = poses["walkTran"][j];
		}
		people.push(JSON.parse(JSON.stringify(personTemplate)));
		people[people.length-1].fixedPose = true;
		people[people.length-1].fixedLoc = true;
		people[people.length-1].x = 150;
		people[people.length-1].loc = people[people.length-1].x;
		for (var j=0; j<10; j++) {
			people[people.length-1].angles[j] = poses["walk1"][j];
		}
		people.push(JSON.parse(JSON.stringify(personTemplate)));
		people[people.length-1].fixedPose = true;
		people[people.length-1].fixedLoc = true;
		people[people.length-1].x = 200;
		people[people.length-1].loc = people[people.length-1].x;
		for (var j=0; j<10; j++) {
			people[people.length-1].angles[j] = poses["walk2"][j];
		}
		people.push(JSON.parse(JSON.stringify(personTemplate)));
		people[people.length-1].fixedPose = true;
		people[people.length-1].fixedLoc = true;
		people[people.length-1].x = 250;
		people[people.length-1].loc = people[people.length-1].x;
		for (var j=0; j<10; j++) {
			people[people.length-1].angles[j] = poses["walk3"][j];
		}
		people.push(JSON.parse(JSON.stringify(personTemplate)));
		people[people.length-1].fixedPose = true;
		people[people.length-1].fixedLoc = true;
		people[people.length-1].x = 300;
		people[people.length-1].loc = people[people.length-1].x;
		for (var j=0; j<10; j++) {
			people[people.length-1].angles[j] = poses["walk4"][j];
		}

		people.push(JSON.parse(JSON.stringify(personTemplate)));
		people[people.length-1].fixedLoc = true;
		people[people.length-1].x = 400;
		people[people.length-1].loc = people[people.length-1].x;
		people[people.length-1].destinationLoc = people[people.length-1].loc;

	}

	// Update the various people
	function update(progress) {

		// Check if people are ready for new actions
		for (var i=0; i<people.length; i++) {

			// If the person is bored of their current action
			if (people[i].boredom >= 100) {

				// If drink is empty
				if (people[i].holding != -1 && people[i].drinkLeft <= 0) {
					people[i].destinationLoc = 500;
					people[i].action = "goingToBin";

				// If need to pee
				} else if (people[i].bladder >= 100) {
					people[i].destinationLoc = 100;
					people[i].action = "goingToBathroom";

				// If don't have a drink
				} else if (people[i].holding == -1) {
					people[i].destinationLoc = 460;
					people[i].action = "goingToFridge";

				// Choose a conversation to join
				} else {

				}

				// No longer bored
				people[i].boredom = 0;

			// Otherwise they get a bit more bored
			} else {
				people[i].boredom += 1;
			}

			// DEBUG
			if (!people[i].fixedLoc){

				// Move their X
				if (people[i].loc > people[i].destinationLoc) {
					people[i].loc -= 1.0;
				} else if (people[i].loc < people[i].destinationLoc) {
					people[i].loc += 1.0;
				}

				// Update Y based on X
				if (people[i].loc > 440) {
					people[i].x = people[i].loc-240;
					people[i].y = 340;
				} else {
					people[i].x = people[i].loc;
					people[i].y = 133;
				}

			}

			if (!people[i].fixedPose){

				// Move towards their pose
				var maxDelta = -1000;
				for (var j=0; j<10; j++) {
					var delta = poses[people[i].pose][j] - people[i].angles[j];
					maxDelta = Math.max(Math.abs(delta), maxDelta);
					if (Math.abs(delta) > 1){
						people[i].angles[j] += people[i].angleDeltas[j];
					}
				}

				// See if the pose needs changing
				if (Math.abs(maxDelta) < 3){

					// Save the old pose
					var oldPose = people[i].pose;

					// Stopping walking
					if      (people[i].action == "standing" && people[i].pose != "standing") {people[i].pose = "standing";}
					else if (people[i].action == "holding" && people[i].pose != "holding") {people[i].pose = "holding";}

					// Walk cycle
					else if (people[i].pose == "walk1") {people[i].pose = "walk2";}
					else if (people[i].pose == "walk2") {people[i].pose = "walk3";}
					else if (people[i].pose == "walk3") {people[i].pose = "walk4";}
					else if (people[i].pose == "walk4") {people[i].pose = "walk1";}

					// Walk cycle whilst holding something
					else if (people[i].pose == "walkHold1") {people[i].pose = "walkHold2";}
					else if (people[i].pose == "walkHold2") {people[i].pose = "walkHold3";}
					else if (people[i].pose == "walkHold3") {people[i].pose = "walkHold4";}
					else if (people[i].pose == "walkHold4") {people[i].pose = "walkHold1";}

					// Starting to walk
					else if (people[i].pose == "standing" && people[i].action == "goingToFridge") {people[i].pose = "walkTran";}
					else if (people[i].pose == "walkTran") {people[i].pose = "walk1";}
					else if (people[i].pose == "walkHoldTran") {people[i].pose = "walkHold1";}

					// Calculate the delta needed each frame between these poses
					for (var j=0; j<10; j++) {
						people[i].angleDeltas[j] = (poses[people[i].pose][j] - poses[oldPose][j]) / 20.0;
					}

				}

				// If reached the destination
				if (people[i].loc == people[i].destinationLoc) {

					// If getting a drink
					if (people[i].action == "goingToFridge") {
						people[i].holding = 0;
						people[i].drinkLeft = 100;
						people[i].action = "holding";
						people[i].boredom = 80;

					// If binning something
					} else if (people[i].action == "goingToBin") {
						people[i].holding = -1;
						people[i].action = "standing";
						people[i].boredom = 80;

					}

				}

			}

		}

	}

	function draw() {

		// Clear the canvas
		ctx.clearRect(0, 0, canvas.width, canvas.height);

		// Draw the background
		ctx.drawImage(placesSVG, 0, 0, placesSVG.width, placesSVG.height, 0, 0, placesSVG.width, placesSVG.height);

		// Draw the people
		for (var i=0; i<people.length; i++) {

			// Overall/torso rotation
			ctx.translate(people[i].x, people[i].y);
			ctx.rotate(people[i].angles[9]*toRad);

			// Right arm
			ctx.translate(9, -30);
			ctx.rotate(people[i].angles[3]*toRad);
			ctx.drawImage(peopleSVG, 2*peopleLoc[2], people[i].sprite*peopleLoc[3], peopleLoc[2], peopleLoc[3], -peopleLoc[2]/2, -peopleLoc[3]/2, peopleLoc[2], peopleLoc[3]);
			ctx.translate(2, 20);
			ctx.rotate(people[i].angles[4]*toRad);
			ctx.drawImage(peopleSVG, 3*peopleLoc[2], people[i].sprite*peopleLoc[3], peopleLoc[2], peopleLoc[3], -peopleLoc[2]/2, -peopleLoc[3]/2, peopleLoc[2], peopleLoc[3]);
			ctx.rotate(-people[i].angles[4]*toRad);
			ctx.translate(-2, -20);
			ctx.rotate(-people[i].angles[3]*toRad);
			ctx.translate(-9, 30);
			
			// Right leg
			ctx.translate(6, 3);
			ctx.rotate(people[i].angles[7]*toRad);
			ctx.drawImage(peopleSVG, 4*peopleLoc[2], people[i].sprite*peopleLoc[3], peopleLoc[2], peopleLoc[3], -peopleLoc[2]/2, -peopleLoc[3]/2, peopleLoc[2], peopleLoc[3]);
			ctx.translate(1, 25);
			ctx.rotate(people[i].angles[8]*toRad);
			ctx.drawImage(peopleSVG, 5*peopleLoc[2], people[i].sprite*peopleLoc[3], peopleLoc[2], peopleLoc[3], -peopleLoc[2]/2, -peopleLoc[3]/2, peopleLoc[2], peopleLoc[3]);
			ctx.rotate(-people[i].angles[8]*toRad);
			ctx.translate(-1, -25);
			ctx.rotate(-people[i].angles[7]*toRad);
			ctx.translate(-6, -3);

			// Torso
			ctx.drawImage(peopleSVG, peopleLoc[2],   people[i].sprite*peopleLoc[3], peopleLoc[2], peopleLoc[3], -peopleLoc[2]/2, -peopleLoc[3]/2, peopleLoc[2], peopleLoc[3]);

			// Head
			ctx.translate(0, -40);
			ctx.rotate(people[i].angles[0]*toRad);
			ctx.drawImage(peopleSVG, 0,              people[i].sprite*peopleLoc[3], peopleLoc[2], peopleLoc[3], -peopleLoc[2]/2, -peopleLoc[3]/2, peopleLoc[2], peopleLoc[3]);
			ctx.rotate(-people[i].angles[0]*toRad);
			ctx.translate(0, 40);

			// Left leg
			ctx.translate(-6, 3);
			ctx.rotate(people[i].angles[5]*toRad);
			ctx.drawImage(peopleSVG, 4*peopleLoc[2], people[i].sprite*peopleLoc[3], peopleLoc[2], peopleLoc[3], -peopleLoc[2]/2, -peopleLoc[3]/2, peopleLoc[2], peopleLoc[3]);
			ctx.translate(1, 25);
			ctx.rotate(people[i].angles[6]*toRad);
			ctx.drawImage(peopleSVG, 5*peopleLoc[2], people[i].sprite*peopleLoc[3], peopleLoc[2], peopleLoc[3], -peopleLoc[2]/2, -peopleLoc[3]/2, peopleLoc[2], peopleLoc[3]);
			ctx.rotate(-people[i].angles[6]*toRad);
			ctx.translate(-1, -25);
			ctx.rotate(-people[i].angles[5]*toRad);
			ctx.translate(6, -3);

			// Left arm
			ctx.translate(-11, -30);
			ctx.rotate(people[i].angles[1]*toRad);
			ctx.drawImage(peopleSVG, 2*peopleLoc[2], people[i].sprite*peopleLoc[3], peopleLoc[2], peopleLoc[3], -peopleLoc[2]/2, -peopleLoc[3]/2, peopleLoc[2], peopleLoc[3]);
			ctx.translate(1, 20);
			ctx.rotate(people[i].angles[2]*toRad);
			if (people[i].holding >= 0) {
				ctx.translate(0, 22);
				ctx.drawImage(objectsSVG, 0, people[i].holding*objectLoc[3], objectLoc[2], objectLoc[3], -objectLoc[2]/2, -objectLoc[3]/2, objectLoc[2], objectLoc[3]);
				ctx.translate(0, -22);
			}
			ctx.drawImage(peopleSVG, 3*peopleLoc[2], people[i].sprite*peopleLoc[3], peopleLoc[2], peopleLoc[3], -peopleLoc[2]/2, -peopleLoc[3]/2, peopleLoc[2], peopleLoc[3]);
			ctx.rotate(-people[i].angles[2]*toRad);
			ctx.translate(-1, -20);
			ctx.rotate(-people[i].angles[1]*toRad);
			ctx.translate(11, 30);

			// Undo torso rotation
			ctx.rotate(-people[i].angles[9]*toRad);
			ctx.translate(-people[i].x, -people[i].y);

		}

		// Write the DEBUG text
		ctx.font = "30px Arial";
		ctx.fillText(debugText, 10, 450);
	}

	// Function calling itself to endlessly loop
	function loop(timestamp) {

		// How much time has passed
		var progress = timestamp - lastRender;

		// Update everything
		update(progress);

		// Re-render everything
		draw();

		// Call the loop again when possible
		lastRender = timestamp;
		window.requestAnimationFrame(loop);

	}

</script>

<body onload="init();">
	<div id="wrapper">
		<canvas id="main"/>
	</div>
</body>

</html> 
